(jac-int-venv) cavin@DESKTOP-KR7GL8A:~/projects/jac-interactive-learning-platform$ # Check the current nginx configuration in our codebase
cat nginx/nginx.conf

# Also check the docker-compose.yml to see how nginx is configured
cat docker-compose.yml
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip Settings
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Upstream backend server
    upstream backend {
        server backend:8000;
    }

    server {
        listen 80;
        server_name localhost;

        # Security Headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

        # Proxy API requests to backend
        location /api/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # CORS Headers
            add_header 'Access-Control-Allow-Origin' '$http_origin' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }
        }

        # WebSocket support
        location /ws/ {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400;
        }

        # Serve frontend static files
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
            try_files $uri $uri/ /index.html;

            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }

            # Don't cache HTML files
            location ~* \.html$ {
                expires -1;
                add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
            }
        }

        # Serve Django static files
        location /static/ {
            alias /var/www/static/;
            expires 1y;
            add_header Cache-Control "public, immutable";
            
            # Don't log static file requests
            access_log off;
            
            # Handle CORS for static files if needed
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: jac_learning_db
      POSTGRES_USER: jac_user
      POSTGRES_PASSWORD: jac_password
      POSTGRES_INITDB_ARGS: --encoding=UTF-8 --lc-collate=C --lc-ctype=C
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - jac_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jac_user -d jac_learning_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache & Session Store
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      - jac_network
    command: redis-server --appendonly yes --requirepass redis_password
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Django Backend API
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    user: "jac:jac"
    environment:
      DEBUG: "False"
      DJANGO_SETTINGS_MODULE: "config.settings"
      DB_NAME: "jac_learning_db"
      DB_USER: "jac_user"
      DB_PASSWORD: "jac_password"
      DB_HOST: "postgres"
      DB_PORT: "5432"
      CELERY_BROKER_URL: "redis://:redis_password@redis:6379/0"
      CELERY_RESULT_BACKEND: "redis://:redis_password@redis:6379/0"
      SECRET_KEY: "${SECRET_KEY:-django-insecure-production-key}"
      CORS_ALLOWED_ORIGINS: "http://localhost:3000,http://frontend:3000"
      # Sentry Error Monitoring
      SENTRY_DSN_BACKEND: "${SENTRY_DSN_BACKEND:-}"
      ENVIRONMENT: "production"
      RELEASE_VERSION: "${RELEASE_VERSION:-1.0.0}"
      SENTRY_TRACES_SAMPLE_RATE: "0.1"
    depends_on:
      - postgres
      - redis
    volumes:
      - ./backend:/app
      - ./backend/static:/app/static
      - ./backend/media:/app/media
      - ./backend/logs:/app/logs
      - static_files:/tmp/staticfiles
    networks:
      - jac_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/api/health/static/ > /dev/null 2>&1 && exit 0 || curl -f http://localhost:8000/api/health/simple/ > /dev/null 2>&1 && exit 0 || curl -f http://localhost:8000/api/health/ > /dev/null 2>&1 && exit 0 || exit 1"]
      interval: 45s
      timeout: 15s
      retries: 5
      start_period: 90s

  # React Frontend (Production Build)
  frontend:
    build: 
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        - REACT_APP_API_URL=http://localhost:8000
        - REACT_APP_WS_URL=ws://localhost:8000
    ports:
      - "3000:80"
    environment:
      REACT_APP_API_URL: "http://localhost:8000/api"
      NODE_ENV: "production"
      # Sentry Error Monitoring
      REACT_APP_SENTRY_DSN: "${REACT_APP_SENTRY_DSN:-}"
      REACT_APP_VERSION: "${RELEASE_VERSION:-1.0.0}"
      REACT_APP_WS_URL: "ws://localhost:8000/ws"
    depends_on:
      - backend
    networks:
      - jac_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep nginx | grep -v grep"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: jac-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - static_files:/var/www/static
    depends_on:
      - frontend
      - backend
    networks:
      - jac_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep nginx | grep -v grep"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Celery Worker for Background Tasks
  celery-worker:
    build: 
      context: ./backend
      dockerfile: Dockerfile.celery-worker
    container_name: jac-celery-worker
    user: "jac:jac"
    # Command is handled by Dockerfile
    environment:
      DJANGO_SETTINGS_MODULE: "config.settings"
      DB_NAME: "jac_learning_db"
      DB_USER: "jac_user"
      DB_PASSWORD: "jac_password"
      DB_HOST: "postgres"
      DB_PORT: "5432"
      CELERY_BROKER_URL: "redis://:redis_password@redis:6379/0"
      CELERY_RESULT_BACKEND: "redis://:redis_password@redis:6379/0"
      # Sentry Error Monitoring
      SENTRY_DSN_BACKEND: "${SENTRY_DSN_BACKEND:-}"
      ENVIRONMENT: "production"
      RELEASE_VERSION: "${RELEASE_VERSION:-1.0.0}"
      SENTRY_TRACES_SAMPLE_RATE: "0.1"
    volumes:
      - ./backend:/app
      - ./backend/logs:/app/logs
    depends_on:
      - postgres
      - redis
    networks:
      - jac_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r = redis.Redis(host='redis', port=6379, password='redis_password'); r.ping()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Celery Beat Scheduler
  celery-beat:
    build: 
      context: ./backend
      dockerfile: Dockerfile.celery-beat
    container_name: jac-celery-beat
    user: "jac:jac"
    # Command is handled by Dockerfile
    environment:
      DJANGO_SETTINGS_MODULE: "config.settings"
      DB_NAME: "jac_learning_db"
      DB_USER: "jac_user"
      DB_PASSWORD: "jac_password"
      DB_HOST: "postgres"
      DB_PORT: "5432"
      CELERY_BROKER_URL: "redis://:redis_password@redis:6379/0"
      CELERY_RESULT_BACKEND: "redis://:redis_password@redis:6379/0"
    volumes:
      - ./backend:/app
      - ./backend/logs:/app/logs
    depends_on:
      - postgres
      - redis
    networks:
      - jac_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r = redis.Redis(host='redis', port=6379, password='redis_password'); r.ping()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # JAC Code Execution Sandbox Service
  jac-sandbox:
    build: 
      context: ./backend
      dockerfile: Dockerfile.jac-sandbox
    container_name: jac-sandbox
    user: "jac:jac"
    # Command is handled by Dockerfile
    ports:
      - "8080:8080"
    environment:
      SANDBOX_TIMEOUT: "30"
      MAX_MEMORY_MB: "128"
      MAX_OUTPUT_SIZE: "1024"
    volumes:
      - ./backend/sandbox:/app/sandbox
      - ./backend/logs:/app/logs
    networks:
      - jac_network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s = socket.socket(); s.settimeout(3); s.connect(('localhost', 8080)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  postgres_data:
  redis_data:
  static_files:

networks:
  jac_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Health Check Configuration
x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3
(jac-int-venv) cavin@DESKTOP-KR7GL8A:~/projects/jac-interactive-learning-platform$ # Copy our custom nginx configuration to the nginx containerthe nginx container
docker-compose exec nginx rm -f /etc/nginx/conf.d/default.conf
docker-compose cp nginx/nginx.conf docker-compose-exec-nginx:/etc/nginx/nginx.conf

# Reload nginx configuration
docker-compose exec nginx nginx -s reload
No such command: cp

Commands:
  build              Build or rebuild services
  config             Validate and view the Compose file
  create             Create services
  down               Stop and remove resources
  events             Receive real time events from containers
  exec               Execute a command in a running container
  help               Get help on a command
  images             List images
  kill               Kill containers
  logs               View output from containers
  pause              Pause services
  port               Print the public port for a port binding
  ps                 List containers
  pull               Pull service images
  push               Push service images
  restart            Restart services
  rm                 Remove stopped containers
  run                Run a one-off command
  scale              Set number of containers for a service
  start              Start services
  stop               Stop services
  top                Display the running processes
  unpause            Unpause services
  up                 Create and start containers
  version            Show version information and quit
2025/11/28 21:47:15 [notice] 512#512: signal process started
(jac-int-venv) cavin@DESKTOP-KR7GL8A:~/projects/jac-interactive-learning-platform$ # Ensure backend has proper permissions for static files
docker-compose exec backend mkdir -p /tmp/staticfiles
docker-compose exec backend chmod -R 755 /tmp/staticfiles

# Run collectstatic
docker-compose exec backend python manage.py collectstatic --noinput

# Copy static files to nginx shared volume
docker-compose exec backend mkdir -p /var/www/static
docker-compose exec backend cp -r /tmp/staticfiles/* /var/www/static/
chmod: changing permissions of '/tmp/staticfiles': Operation not permitted
Traceback (most recent call last):
  File "/app/manage.py", line 32, in <module>
    main()
  File "/app/manage.py", line 28, in main
    execute_from_command_line(sys.argv)
  File "/home/jac/venv/lib/python3.11/site-packages/django/core/management/__init__.py", line 442, in execute_from_command_line
    utility.execute()
  File "/home/jac/venv/lib/python3.11/site-packages/django/core/management/__init__.py", line 436, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File "/home/jac/venv/lib/python3.11/site-packages/django/core/management/base.py", line 416, in run_from_argv
    self.execute(*args, **cmd_options)
  File "/home/jac/venv/lib/python3.11/site-packages/django/core/management/base.py", line 460, in execute
    output = self.handle(*args, **options)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jac/venv/lib/python3.11/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py", line 209, in handle
    collected = self.collect()
                ^^^^^^^^^^^^^^
  File "/home/jac/venv/lib/python3.11/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py", line 135, in collect
    handler(path, prefixed_path, storage)
  File "/home/jac/venv/lib/python3.11/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py", line 378, in copy_file
    self.storage.save(prefixed_path, source_file)
  File "/home/jac/venv/lib/python3.11/site-packages/django/core/files/storage/base.py", line 49, in save
    name = self._save(name, content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/jac/venv/lib/python3.11/site-packages/django/core/files/storage/filesystem.py", line 100, in _save
    os.makedirs(directory, exist_ok=True)
  File "<frozen os>", line 215, in makedirs
  File "<frozen os>", line 225, in makedirs
PermissionError: [Errno 13] Permission denied: '/tmp/staticfiles/admin'
mkdir: cannot create directory ‘/var/www’: Permission denied
cp: cannot stat '/tmp/staticfiles/*': No such file or directory
(jac-int-venv) cavin@DESKTOP-KR7GL8A:~/projects/jac-interactive-learning-platform$ # Test nginx configuration
docker-compose exec nginx nginx -t

# Check if static files are accessible through nginx
curl -I http://localhost:8000/static/admin/css/dashboard.css

# Test frontend login page
curl -I http://localhost:3000/login
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
HTTP/1.1 404 Not Found
Date: Fri, 28 Nov 2025 21:47:36 GMT
Server: WSGIServer/0.2 CPython/3.11.14
Content-Type: text/html; charset=utf-8
X-Frame-Options: DENY
Content-Length: 179
X-Content-Type-Options: nosniff
Referrer-Policy: same-origin
Cross-Origin-Opener-Policy: same-origin
Vary: origin

HTTP/1.1 200 OK
Server: nginx/1.29.3
Date: Fri, 28 Nov 2025 21:47:36 GMT
Content-Type: text/html
Content-Length: 592
Last-Modified: Fri, 28 Nov 2025 19:46:42 GMT
Connection: keep-alive
ETag: "6929fc22-250"
X-Frame-Options: SAMEORIGIN
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Referrer-Policy: no-referrer-when-downgrade
Content-Security-Policy: default-src 'self' http: https: data: blob: 'unsafe-inline'
Accept-Ranges: bytes

(jac-int-venv) cavin@DESKTOP-KR7GL8A:~/projects/jac-interactive-learning-platform$ # Check nginx access and error logs
docker-compose exec nginx tail -20 /var/log/nginx/access.log
docker-compose exec nginx tail -20 /var/log/nginx/error.log

# Check frontend container logs
docker-compose logs frontend

